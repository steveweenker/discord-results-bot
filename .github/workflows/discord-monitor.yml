name: Discord Results Monitor Bot

on:
  schedule:
    # Runs every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check_interval:
        description: 'Check interval in seconds'
        required: false
        default: '30'
        type: string

jobs:
  monitor-results:
    runs-on: ubuntu-latest
    timeout-minutes: 55  # Stop after 55 minutes (GitHub limit 60)

    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“‹ Validate Setup
        run: |
          echo "ðŸ” Validating configuration..."
          if [ ! -f "registration_numbers.txt" ]; then
            echo "âŒ registration_numbers.txt not found!"
            exit 1
          fi
          reg_count=$(grep -c "^[0-9]\{11\}$" registration_numbers.txt || true)
          echo "ðŸ“Š Found $reg_count valid registration numbers"
          if [ $reg_count -eq 0 ]; then
            echo "âš ï¸ No valid 11-digit registration numbers found!"
            exit 1
          fi
          echo "âœ… Configuration validated successfully"

      - name: ðŸ” Run Discord Results Monitor
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          CHECK_INTERVAL: ${{ github.event.inputs.check_interval || '30' }}
          PYTHONUNBUFFERED: 1
        run: |
          echo "ðŸŽ¯ Starting Discord Results Monitor Bot..."
          echo "â±ï¸ Check interval: ${CHECK_INTERVAL} seconds"
          echo "ðŸ• Maximum runtime: 55 minutes"
          echo "ðŸ“… Started at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âŒ DISCORD_WEBHOOK secret is not set!"
            exit 1
          fi
          timeout 3300 python discord_bot.py || exit_code=$?
          case ${exit_code:-0} in
            0)
              echo "âœ… Bot completed successfully"
              ;;
            124)
              echo "â° Job reached timeout limit"
              echo "ðŸ”„ Next scheduled run will continue monitoring"
              ;;
            *)
              echo "âŒ Bot exited with error code: ${exit_code:-0}"
              exit ${exit_code:-0}
              ;;
          esac

      - name: ðŸ“Š Generate Job Summary
        if: always()
        run: |
          echo "# ðŸ“Š Discord Results Monitor - Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• Started At | $(date -u -d '55 minutes ago' '+%Y-%m-%d %H:%M:%S UTC' 2>/dev/null || date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Finished At | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Python Version | $(python --version) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Registration Numbers | $(grep -c '^[0-9]' registration_numbers.txt 2>/dev/null || echo '0') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Next Scheduled Run | $(date -u -d '+5 minutes' '+%Y-%m-%d %H:%M:%S UTC' 2>/dev/null || echo 'In 5 minutes') |" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Bot Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Registration file found**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Monitoring active**: Checking every ${{ github.event.inputs.check_interval || '30' }} seconds" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Discord notifications**: Real-time updates sent" >> $GITHUB_STEP_SUMMARY
